
{#
The base template that handles the navbar/menus and the main Contents menu.

Includes a releaase_number constant that needs to match the RELEASE_NUMBER in home_utils.py.

For an explanation of how "hidden buttons" are used, see webapp/home/utils.hidden_buttons.py.
#}

{% extends 'bootstrap/base.html' %}
{% import '_macros.html' as macros %}

{# The following must agree with RELEASE_NUMBER in home_utils.py #}
{% set release_number = '2025.07.03' %}
{% set optional = 'Black' %}

{% block head %}
    {{ super() }}
    <link rel="stylesheet" type="text/css" href="//code.jquery.com/ui/1.12.1/themes/base/jquery-ui.css">
    <link rel="stylesheet" type="text/css" href="https://cdn.datatables.net/1.12.1/css/jquery.dataTables.css">
    <script src="//code.jquery.com/jquery-1.12.4.js"></script>
    <script src="//code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.js"></script>
    <link href="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/css/bootstrap.min.css" rel="stylesheet"/>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/directory-list.css', version=release_number) }}">
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/base.css', version=release_number) }}">
    <script src="//maxcdn.bootstrapcdn.com/bootstrap/3.2.0/js/bootstrap.min.js"></script>
{% endblock %}

{% block title %}
{% if title %}{{ title }} - ezEML Metadata Editor{% endif %}
{% endblock %}

{# Some pages do not require content to be saved before leaving the page, because there is
   nothing entered on that page that needs to be saved. The action invoked by a menu item can
   be different depending on whether or not we are on such a page. If we are, the "New" menu
   item, for example, can go directly to the home.create page. Otherwise, it needs first to
   go to the handler for the page so it can save the content, after which the hidden button is
   handled in that other page's handler. See, for example, the EML Documents dropdown menu, below,
   and the macro toolbar_menu_item(). #}
{% set non_saving_endswith = ['/eml/', '/create', '/open_eml_document', '/close',
        '/load_data', 'load_other_entity', 'check_metadata', 'delete',
        '/import_parties', '/import_geo_coverage',
        '/import_taxonomic_coverage', '/import_funding_awards',
        'about', 'news', 'user_guide', 'faq', 'import_package', 'import_xml',
        'export_package', 'settings', '/open_template', 'save_as_template', 'delete_template', 'display_templates'] %}
{% set non_saving_contains = ['_select', '/check_metadata/', '/check_data_tables/', '/explore_data_tables/',
        '/data_table_errors/', '/fetch_xml', '/file_error', '/manage_packages',
        '/import_parties_2/', '/import_geo_coverage_2/',
        '/import_taxonomic_coverage_2/', '/import_funding_awards_2/',
        'import_package_2', 'import_xml_2', 'export_package_2',
        '/send_to_other', '/load_geo_coverage', '/new_from_template',
        '/load_taxonomic_coverage', '/load_taxonomic_coverage_2',
        '/manage_data_usage', '/curator_workflow', '/submit_package', '/validate_eml'] %}
{% set ns = namespace(is_non_saving = false) %}
{% for page in non_saving_endswith %}
    {% if request.path.endswith(page) %}
        {% set ns.is_non_saving = true %}
    {% endif %}
{% endfor %}
{% for page in non_saving_contains %}
    {% if page in request.path %}
        {% set ns.is_non_saving = true %}
    {% endif %}
{% endfor %}

{% block navbar %}

<nav class="navbar navbar-default">
    <div class="container-fluid">
        {# Top-of-page navbar #}
        <div class="navbar-header">
            <table>
                <td width="5%"></td>
                {# EDI logo home button #}
                <td style="vertical-align: middle">
                    {% if ns.is_non_saving %}
                    <a href="{{ url_for('home.index') }}"><img style="width: 32px; width: 32px;" src="{{ url_for('static', filename='EDI-logo-300DPI_5.png') }}"></a>
                    {% else %}
                    <a href="#" onclick="$('#hidden_index').click();"><img style="width: 32px; width: 32px;" src="{{ url_for('static', filename='EDI-logo-300DPI_5.png') }}"></a>
                    {% endif %}
                </td>
                <td width="5%"></td>
                {# ezEML home button #}
                <td>
                    <button aria-controls="navbar" aria-expanded="false"
                            class="navbar-toggle collapsed" data-target="#top-navbar"
                            data-toggle="collapse" type="button">
                        <span class="sr-only">Toggle navigation</span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                        <span class="icon-bar"></span>
                    </button>
                    {% if ns.is_non_saving %}
                    <a class="navbar-brand" href="{{ url_for('home.index') }}" title="ezEML">ezEML</a>
                    {% else %}
                    <a class="navbar-brand" href="#" onclick="$('#hidden_index').click();">ezEML</a>
                    {% endif %}
                </td>
            </table>
        </div>
        <div class="navbar-collapse collapse" id="top-navbar">
            {# EML Documents menu #}
            <ul class="nav navbar-nav">
            {% if current_user.is_authenticated %}
                <li class="dropdown">
                    <a aria-expanded="false" aria-haspopup="true"
                       class="dropdown-toggle" data-toggle="dropdown" href="#"
                       role="button">EML Documents<span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        {# The following <li> is for debugging. Uncomment it to display in the
                            dropdown menu the state of is_non_saving and the request path. This
                            is helpful if debugging something related to is_non_saving. See the
                            explanation in the vicinity of line 20, above. #}
{#                        <li>{{ ns.is_non_saving }}  {{ request.path }}</li>#}
                        {{ macros.toolbar_menu_item(url_for('home.create'), 'hidden_new', 'New...', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.new_from_template'), 'hidden_new_from_template', 'New from Template...', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.open_eml_document'), 'hidden_open', 'Open...', ns.is_non_saving) }}
                    {% if current_user.get_filename() %}
                        {{ macros.toolbar_menu_item(url_for('home.close'), 'hidden_close', 'Close', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.save'), 'hidden_save', 'Save', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.save_as'), 'hidden_save_as', 'Save As...', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.rename_package'), 'hidden_rename_package', 'Rename...', ns.is_non_saving) }}
                    {% endif %}
                        {{ macros.toolbar_menu_item(url_for('home.settings'), 'hidden_settings', 'Settings...', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.manage_packages'), 'hidden_manage', 'Manage...', ns.is_non_saving) }}
                    {% if session["authorized_to_manage_templates"] %}
                        <li>
                            <hr style="border-top: 1px solid #B0B0B0;">
                        </li>
                        {{ macros.toolbar_menu_item(url_for('home.manage_templates'), 'hidden_manage_templates', 'Manage Templates...', ns.is_non_saving) }}
{#                        {{ macros.toolbar_menu_item(url_for('home.open_template'), 'hidden_open_template', 'Open Template...', ns.is_non_saving) }}#}
{#                        {{ macros.toolbar_menu_item(url_for('home.save_as_template'), 'hidden_save_as_template', 'Save As Template...', ns.is_non_saving) }}#}
{#                        {{ macros.toolbar_menu_item(url_for('home.delete_template'), 'hidden_delete_template', 'Delete Template...', ns.is_non_saving) }}#}
{#                        {{ macros.toolbar_menu_item(url_for('home.display_templates'), 'hidden_display_templates', 'Display Templates', ns.is_non_saving) }}#}
                    {% endif %}
                    </ul>
                </li>
            {% endif %}
            {% if current_user.is_authenticated %}
                <li class="dropdown">
                    <a aria-expanded="false" aria-haspopup="true"
                       class="dropdown-toggle" data-toggle="dropdown" href="#"
                       role="button">Import/Export<span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        {% if current_user.get_filename() %}
                        {{ macros.toolbar_menu_item(url_for('home.import_parties'), 'hidden_import_parties', 'Import Responsible Parties (Creators, Contacts, etc.)', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.import_keywords'), 'hidden_import_keywords', 'Import Keywords', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.import_geo_coverage'), 'hidden_import_geo_coverage', 'Import Geographic Coverage', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.import_taxonomic_coverage'), 'hidden_import_taxonomic_coverage', 'Import Taxonomic Coverage', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.import_funding_awards'), 'hidden_import_funding_awards', 'Import Funding Awards', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.import_project'), 'hidden_import_project', 'Import Project', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.import_related_projects'), 'hidden_import_related_projects', 'Import Related Projects', ns.is_non_saving) }}
                        <li>
                            <hr style="border-top: 1px solid #B0B0B0;">
                        </li>
                {% endif %}
                {% if current_user.is_authenticated %}
                        {{ macros.toolbar_menu_item(url_for('home.fetch_xml'), 'hidden_fetch_from_EDI', 'Fetch a Package from EDI...', ns.is_non_saving) }}
                        {% if current_user.get_filename() %}
                            {{ macros.toolbar_menu_item(url_for('home.preview_data_portal'), 'hidden_preview_data_portal', "Preview Your Metadata in the EDI Data Portal...", ns.is_non_saving) }}
                        {% endif %}
                        <li>
                            <hr style="border-top: 1px solid #B0B0B0;">
                        </li>
                {% endif %}
                {% if current_user.get_filename() %}
                        {{ macros.toolbar_menu_item(url_for('home.download_current'), 'hidden_download', 'Download EML File (XML)', ns.is_non_saving) }}
                {% endif %}
                {% if current_user.is_authenticated %}
                        {{ macros.toolbar_menu_item(url_for('home.import_xml'), 'hidden_import_xml', 'Import EML File (XML)...', ns.is_non_saving) }}
                {% endif %}
                {% if current_user.is_authenticated %}
                        {{ macros.toolbar_menu_item(url_for('home.export_package'), 'hidden_export_ezEML_data_package', 'Export ezEML Data Package...', ns.is_non_saving) }}
                {% endif %}
                        {{ macros.toolbar_menu_item(url_for('home.import_package'), 'hidden_import_ezEML_data_package', 'Import ezEML Data Package...', ns.is_non_saving) }}
                        <li>
                            <hr style="border-top: 1px solid #B0B0B0;">
                        </li>
                        {{ macros.toolbar_menu_item(url_for('home.validate_eml'), 'hidden_validate_eml', 'Validate an EML XML File...', ns.is_non_saving) }}
                    </ul>
                </li>
            {% endif %}
                <li class="dropdown">
                    <a aria-expanded="false" aria-haspopup="true"
                       class="dropdown-toggle" data-toggle="dropdown" href="#"
                       role="button">EDI Info
                        <span class="caret"></span>
                    </a>
                    <ul class="dropdown-menu">
                        <li>
                           <a href="https://edirepository.org/" target="_blank">Environmental Data Initiative (EDI)</a>
                        </li>
                        <li>
                            <a href="https://portal.edirepository.org/nis/home.jsp" target="_blank">EDI Data Portal</a>
                        </li>
                        <li>
                            <a href="https://pastaplus-core.readthedocs.io/en/latest/index.html" target="_blank">PASTAplus</a>
                        </li>
                        <li>
                            <a href="https://lternet.edu/" target="_blank">LTER Network</a>
                        </li>
                    </ul>
                </li>
                        {{ macros.toolbar_menu_item(url_for('home.user_guide'), 'hidden_user_guide', 'User Guide', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.faq'), 'hidden_faq', 'FAQ', ns.is_non_saving) }}
                        {{ macros.toolbar_menu_item(url_for('home.about'), 'hidden_about', 'About', ns.is_non_saving) }}
{#                        {{ macros.toolbar_menu_item(url_for('home.news'), 'hidden_news', 'News', ns.is_non_saving) }}#}
                        {# News is a special case so we can highlight it when there are new items #}
                        <li><a id="news_item" href="{{ url_for('home.news') }}" title="News">News</a></li>
            </ul>
            <ul class="nav navbar-nav navbar-right">
                {% if current_user.is_anonymous %}
                    {% if url_for(request.endpoint, **request.view_args) != '/eml/auth/login' %}
                        <li><a href="/eml/edit/login">Login</a></li>
                    {% endif %}
                {% else %}
                <li>
                    <table style="height: 50px;" valign="middle">
{#                        <td>#}
{#                             <input id="nav_save" style="display: none;color: steelblue;font-weight: bold;" class="btn btn-link" name="Save" type="submit" value="Save"/>#}
{#                        </td>#}
                        {% if session['collaboration_enabled_for_user'] %}
                        <td>
                            <ul class="nav navbar-nav">
                            {{ macros.toolbar_menu_item(url_for('collab.collaborate'), 'hidden_collaborate', 'Collaborate', ns.is_non_saving) }}
                            </ul>
                        </td>
                            {% if session['release_to_owner_link'] %}
                            <td>
                                <ul class="nav navbar-nav">
                                    {{ macros.toolbar_menu_item(url_for('home.release_to_owner'), 'hidden_release_to_owner', 'Release to Owner', ns.is_non_saving) }}
                                </ul>
                            </td>
                            {% endif %}
                        {% endif %}
                        <td>
                            <ul class="nav navbar-nav">
                            {{ macros.toolbar_menu_item(url_for('auth.logout'), 'hidden_logout', 'Logout', ns.is_non_saving) }}
                            </ul>
                        </td>
                    </table>
                </li>
                {% endif %}
            </ul>
        </div>
        {% if current_user.is_authenticated %}
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-2">
            <ul class="nav navbar-nav">
                <li>
{#                {{ session['active_package_id'] }}#}
                    Welcome Back <strong>{{ current_user.get_username() }}</strong>
                    {% if current_user.get_filename() %}
                        &nbsp;&nbsp;
                    &nbsp;&nbsp;Active EML Document: <strong>{{ current_user.get_filename() }}</strong>
                        {% if current_user.get_file_owner() %}
                            &nbsp;&nbsp;<i>[owned by <strong>{{ current_user.get_file_owner() }}</strong>]</i>
                        {% endif %}
                    {% endif %}
                </li>
            </ul>
        </div>
        {% endif %}
    </div>
</nav>
{% endblock %}

{% block content %}
<div class="container">
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    {% for category, message in messages %}
    <div class="alert alert-info {{ category }}" role="alert">{{ message|replace('\n', '<br>')|safe }}</div>
    {% endfor %}
    {% endif %}
    {% endwith %}

    <div id="contents_div" style="width: 18%; float: left;">
        <br>
        {% if current_user.is_authenticated %}
                <table border="0">
                    <td style="width:2%;"><h4 class="nav_link">Contents</h4><p></p></td>
                    <td><table width="10%">
                    <td style="width:2%; text-align:right; vertical-align:middle; padding-bottom: 2px;">{{ macros.help_button('__help__contents_btn', 'nav_link') }}</td>
                    </table></td>
                </table>
            {% set title_style = '""'|safe %}
            {% set creator_style = '""'|safe %}
            {% set metadata_provider_style = '""'|safe %}
            {% set associated_party_style = '""'|safe %}
            {% set abstract_style = '""'|safe %}
            {% set keyword_style = '""'|safe %}
            {% set intellectual_rights_style = '""'|safe %}
            {% set geographic_coverage_style = '""'|safe %}
            {% set temporal_coverage_style = '""'|safe %}
            {% set taxonomic_coverage_style = '""'|safe %}
            {% set maintenance_style = '""'|safe %}
            {% set contact_style = '""'|safe %}
            {% set publisher_style = '""'|safe %}
            {% set publication_info_style = '""'|safe %}
            {% set method_step_style = '""'|safe %}
            {% set project_style = '""'|safe %}
            {% set data_table_style = '""'|safe %}
            {% set other_entity_style = '""'|safe %}
            {% set data_package_id_style = '""'|safe %}
            {% set check_metadata_style = '""'|safe %}
            {% set check_data_tables_style = '""'|safe %}
            {% set explore_data_tables_style = '""'|safe %}
            {% set share_submit_package_style = '""'|safe %}
            {% set submit_package_style = '""'|safe %}
            {% set send_to_other_style = '""'|safe %}
            {% set collaborate_style = '""'|safe %}
            {% set manage_data_usage_style = '""'|safe %}
            {% set curator_workflow_style = '""'|safe %}

            {# Mark the current page with a bold font.#}
            {% set page = session['current_page'] %}
            {% set current = '"font-weight: bold;color: #0060d8;"'|safe %}
            {% if page == 'title' %}{% set title_style = current %}{% endif %}
            {% if page == 'creator' %}{% set creator_style = current %}{% endif %}
            {% if page == 'metadata_provider' %}{% set metadata_provider_style = current %}{% endif %}
            {% if page == 'associated_party' %}{% set associated_party_style = current %}{% endif %}
            {% if page == 'abstract' %}{% set abstract_style = current %}{% endif %}
            {% if page == 'keyword' %}{% set keyword_style = current %}{% endif %}
            {% if page == 'intellectual_rights' %}{% set intellectual_rights_style = current %}{% endif %}
            {% if page == 'geographic_coverage' %}{% set geographic_coverage_style = current %}{% endif %}
            {% if page == 'temporal_coverage' %}{% set temporal_coverage_style = current %}{% endif %}
            {% if page == 'taxonomic_coverage' %}{% set taxonomic_coverage_style = current %}{% endif %}
            {% if page == 'maintenance' %}{% set maintenance_style = current %}{% endif %}
            {% if page == 'contact' %}{% set contact_style = current %}{% endif %}
            {% if page == 'publisher' %}{% set publisher_style = current %}{% endif %}
            {% if page == 'publication_info' %}{% set publication_info_style = current %}{% endif %}
            {% if page == 'method_step' %}{% set method_step_style = current %}{% endif %}
            {% if page == 'project' %}{% set project_style = current %}{% endif %}
            {% if page == 'data_table' %}{% set data_table_style = current %}{% endif %}
            {% if page == 'other_entity' %}{% set other_entity_style = current %}{% endif %}
            {% if page == 'data_package_id' %}{% set data_package_id_style = current %}{% endif %}
            {% if page == 'check_metadata' %}{% set check_metadata_style = current %}{% endif %}
            {% if page == 'check_data_tables' %}{% set check_data_tables_style = current %}{% endif %}
            {% if page == 'explore_data_tables' %}{% set explore_data_tables_style = current %}{% endif %}
            {% if page == 'share_submit_package' %}{% set share_submit_package_style = current %}{% endif %}
            {% if page == 'submit_package' %}{% set submit_package_style = current %}{% endif %}
            {% if page == 'send_to_other' %}{% set send_to_other_style = current %}{% endif %}
            {% if page == 'collaborate' %}{% set collaborate_style = current %}{% endif %}
            {% if page == 'grant_access' %}{% set grant_access_style = current %}{% endif %}
            {% if page == 'manage_data_usage' %}{% set manage_data_usage_style = current %}{% endif %}
            {% if page == 'curator_workflow' %}{% set curator_workflow_style = current %}{% endif %}

        {# Handle clicks on the main Contents menu.#}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='res.title'), title_style, 'hidden_title', 'Title', ns.is_non_saving, 'title', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='dt.data_table_select'), data_table_style, 'hidden_data_tables', 'Data Tables', ns.is_non_saving, 'data_tables', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='rp.creator_select'), creator_style, 'hidden_creators', 'Creators', ns.is_non_saving, 'creators', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='rp.contact_select'), contact_style, 'hidden_contacts', 'Contacts', ns.is_non_saving, 'contacts', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='rp.associated_party_select'), associated_party_style, 'hidden_associated_parties', 'Associated Parties', ns.is_non_saving, 'associated_parties', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='rp.metadata_provider_select'), metadata_provider_style, 'hidden_metadata_providers', 'Metadata Providers', ns.is_non_saving, 'metadata_providers', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='res.abstract'), abstract_style, 'hidden_abstract', 'Abstract', ns.is_non_saving, 'abstract', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='res.keyword_select'), keyword_style, 'hidden_keywords', 'Keywords', ns.is_non_saving, 'keywords', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='res.intellectual_rights'), intellectual_rights_style, 'hidden_intellectual_rights', 'Intellectual Rights', ns.is_non_saving, 'intellectual_rights', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='cov.geographic_coverage_select'), geographic_coverage_style, 'hidden_geographic_coverage', 'Geographic Coverage', ns.is_non_saving, 'geographic_coverage', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='cov.temporal_coverage_select'), temporal_coverage_style, 'hidden_temporal_coverage', 'Temporal Coverage', ns.is_non_saving, 'temporal_coverage', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='cov.taxonomic_coverage_select'), taxonomic_coverage_style, 'hidden_taxonomic_coverage', 'Taxonomic Coverage', ns.is_non_saving, 'taxonomic_coverage', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='maint.maintenance'), maintenance_style, 'hidden_maintenance', 'Maintenance', ns.is_non_saving, 'maintenance', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='rp.publisher'), publisher_style, 'hidden_publisher', 'Publisher', ns.is_non_saving, 'publisher', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='res.publication_info'), publication_info_style, 'hidden_publication_info', 'Publication Info', ns.is_non_saving, 'publication_info', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='md.method_step_select'), method_step_style, 'hidden_methods', 'Methods', ns.is_non_saving, 'methods', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='proj.project'), project_style, 'hidden_project', 'Project', ns.is_non_saving, 'project', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='ent.other_entity_select'), other_entity_style, 'hidden_other_entities', 'Other Entities', ns.is_non_saving, 'other_entities', badge_data) }}
        {{ macros.contents_menu_item_with_status(url_for('home.edit', page='res.data_package_id'), data_package_id_style, 'hidden_data_package_id', 'Data Package ID', ns.is_non_saving, 'data_package_id', badge_data) }}
            <hr class="nav_link" style="border-top: 1px solid lightgray" width="100px" align="left">
        <a class="nav_link {{ session['check_metadata_status'] }}_circle" href="{{ url_for('home.check_metadata') }}"></a>&nbsp;
            <a class="nav_link" style={{ check_metadata_style }}; href="{{ url_for('home.edit', page='home.check_metadata') }}" title="Edit">Check Metadata</a>&nbsp;
            <br>
        {% if current_user and current_user.is_authenticated %}
            <a class="nav_link {{ session['check_data_tables_status'] }}_circle" href="{{ url_for('home.check_data_tables') }}"></a>&nbsp;
            <a class="nav_link" style={{ check_data_tables_style }}; href="{{ url_for('home.edit', page='home.check_data_tables') }}" title="Edit">Check Data Tables</a>&nbsp;
            <br>
            <div class="nav_link white_circle"></div>&nbsp;
        <a class="nav_link" style={{ explore_data_tables_style }}; href="{{ url_for('home.edit', page='home.explore_data_tables') }}" title="Edit">Explore Data Tables</a>&nbsp;
{#            <br>#}
        {% endif %}
        <hr class="nav_link" style="border-top: 1px solid lightgray" width="100px" align="left">
        <a class="nav_link" style={{ share_submit_package_style }}; href="{{ url_for('home.edit', page='home.share_submit_package') }}" title="Edit">Submit/Share Package</a><br>

        {% if current_user and current_user.is_authenticated and
            (current_user.is_admin() or current_user.is_data_curator() or current_user.is_publish_at_edi_authorized()) %}
        <hr class="nav_link" style="border-top: 1px solid lightgray" width="100px" align="left">
        {% endif %}
        {% if current_user and current_user.is_authenticated and
            (current_user.is_admin() or current_user.is_publish_at_edi_authorized()) %}
        <a class="nav_link" style={{ curator_workflow_style }}; href="{{ url_for('home.edit', page='workflow.curator_workflow') }}" title="Edit">Publish at EDI</a><br>
        {% endif %}

        {% if current_user and current_user.is_authenticated and (current_user.is_admin() or current_user.is_data_curator()) %}
        <a class="nav_link" style={{ manage_data_usage_style }}; href="{{ url_for('home.edit', page='home.manage_data_usage') }}" title="Edit">Manage Data Usage</a><br>
        {% endif %}

        {% endif %}
    </div>
    <div id="app_div" style="margin-left: 18%;">
        {# application content needs to be provided in the app_content block #}
        {% block app_content %}{% endblock %}
    </div>
</div>

    {% set help_badges_id, help_badges_title, help_badges_content = ('badges', 'Colored Badges in ezEML',
'In the <b>Contents</b> menu on the left, and elsewhere in ezEML, you\'ll see round colored "badges." These badges indicate the presence of errors (<span style="color:#DD1111;font-weight:bold;">red</span>) or warnings (<span style="color:#FFA500;font-weight:bold;">yellow</span>), or their absence (<span style="color:#009E60;font-weight:bold;">green</span>).
<p style="height:10px;margin:0;"></p>
The yellow and red badges are usually clickable, as indicated by a tooltip that appears when you hover on them. Clicking them causes the relevant errors/warnings to be displayed, and the errors/warnings themselves are clickable, taking you directly to the item in question.
<p style="height:10px;margin:0;"></p>
Your goal in editing an ezEML data package should be to enter all required or
recommended metadata and make corrections until, at the minimum, no red badges remain.
Even better would be to get rid of all warnings, as well, and thereby make all badges green.
<p style="height:10px;margin:0;"></p>
For green badges, there\'s nothing to display, so they\'re not clickable.
<p style="height:10px;margin:0;"></p>
Watch a short demo video here:&nbsp;&nbsp;<a href="https://youtu.be/_FoRUJ7DqIc" target="_ezeml_user_guide"><img src="/user-data/youtube.png" style="height:18px;width:auto;"></a>
<p style="height:10px;margin:0;"></p>
<table style="width:100%;border 1px solid;">
<th></th><th>Color Key for Status Badges</th>
    <tr><td width=3%><span class ="nav_link red_circle"></span></td><td width=97%>Metadata errors found. Click the badge for details.</td></tr>
    <tr><td><span class ="nav_link yellow_circle"></span></td><td>Metadata warnings found. Click the badge for details.</td></tr>
    <tr><td><span class ="nav_link green_circle"></span></td><td>Metadata entered; no errors or warnings found.</td></tr>
    <tr><td><span class ="nav_link white_key_circle"></span></td><td>No metadata entered, and metadata is not required.</td></tr>
</table>

<hr style="border-top: 1px solid darkgray;">
<input type="checkbox" id="do_not_show" name="do_not_show" onchange="do_not_show_change_clicked(this);">&nbsp;Got it. Don\'t show this dialog again.</input>
<script>
localStorage.getItem("do_not_show_badges_dialog_1");
function do_not_show_change_clicked(checkbox) {
    localStorage.setItem("do_not_show_badges_dialog_1", checkbox.checked);
}
</script>') %}
    {% set help_badges_btn = help_badges_id ~ '_btn' %}
    {% set help_badges_dialog = help_badges_id ~ '_dialog' %}
                        <span hidden="hidden">{{ macros.help_button(help_badges_btn) }}</span>

    {{ macros.help_dialog('__help__contents_dialog', session['__help__contents'][0], session['__help__contents'][1]) }}
    {{ macros.help_dialog(help_badges_dialog, help_badges_title, help_badges_content) }}

{% endblock %}

{% block scripts %}
    {{ super() }}
    <script>
    $(function()
    {
        let nav_link = $('.nav_link');
        let contents_div = $('#contents_div');
        let app_div = $('#app_div');
        let hide_contents_menu = $('#hide_contents_menu');
        if (hide_contents_menu.length > 0) {
            nav_link.hide(); // this hides the Contents menu
        }
        // Certain pages want to be displayed full width.
        {% if request.path.endswith('/collaborate') or '/collaborate/' in request.path or
                request.path.endswith('/show_backups') or '/show_backups/' in request.path or
                request.path.endswith('/manage_packages') or '/manage_packages/' in request.path %}
            contents_div.width('0px');
            app_div.css({'margin-left':'0px'});
            nav_link.hide();
        {% endif %}

        });
    </script>

    <script>
    $(document).ready(function() {
        // html has had visibility set to hidden (see base.css) until the page has finish loading. make visible.
        document.getElementsByTagName("html")[0].style.visibility = "visible";
        $(".yellow_circle").tooltip({
            // No additional options needed for immediate display
        });
        $(".red_circle").tooltip({
        // No additional options needed for immediate display
        });
        $(".popup").tooltip({
        // No additional options needed for immediate display
        });
    });
    </script>

    {% block app_scripts %}

    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/jquery-1.12.4.js"></script>
    <script type="text/javascript" charset="utf8" src="https://code.jquery.com/ui/1.12.1/jquery-ui.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/jquery.dataTables.js"></script>
    <script type="text/javascript" charset="utf8" src="https://cdn.datatables.net/1.12.1/js/dataTables.bootstrap5.js"></script>

    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles/base.css', version=release_number) }}">

    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <!-- Bootstrap JS -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>

    <script>
    $(function()
    {
        {{ macros.help_script('__help__contents_dialog', '__help__contents_btn') }}
    });
    </script>

    {% set help_badges_id = 'badges' %}
    {% set help_badges_btn = help_badges_id ~ '_btn' %}
    {% set help_badges_dialog = help_badges_id ~ '_dialog' %}
    <script>
    $(function()
    {
        {{ macros.help_script(help_badges_dialog, help_badges_btn) }}
        let do_not_show = localStorage.getItem("do_not_show_badges_dialog_1") == 'true';
        if (!do_not_show && $('.nav_link').is(':visible')) {
            let badges_dialog = $('#{{ help_badges_dialog }}').dialog({
                autoOpen: true,
                width: 500,
                position: {my: "center", at: "center", of: window}
            });
            $('#{{ help_badges_btn }}').button().on('click', function () {
                if (badges_dialog.dialog('isOpen')) {
                    badges_dialog.dialog('close');
                } else {
                    badges_dialog.dialog('open');
                }
            });
            $('#{{ help_badges_btn }}').click();
            document.activeElement.blur();
        }
    });
    </script>

    <script>
    // Function to check if there are unsaved changes
    function hasUnsavedChanges() {
        return sessionStorage.getItem('unsavedChanges') === 'true';
    }

    // Function to set the flag indicating unsaved changes
    function setUnsavedChanges(flag) {
        sessionStorage.setItem('unsavedChanges', flag ? 'true' : 'false');
    }

    // Optionally, a function to clear the flag
    function clearUnsavedChanges() {
        sessionStorage.removeItem('unsavedChanges');
    }
    </script>

    <script>
    $(document).ready(function() {
        clearUnsavedChanges();
    });
    </script>

    <script>
    $(document).ready(function() {
        let news_datetime = {{ session["news_datetime"] }};
        let news_item = document.getElementById('news_item');
        if (localStorage.getItem('news_viewed') == null || parseInt(localStorage.getItem('news_viewed')) < parseInt(news_datetime)) {
            news_item.style.color = 'red';
            news_item.style.fontWeight = 'bold';
            news_item.style.fontStyle = 'italic';
        };
    });
    </script>

    <script>
    // --------------------------------------------------------------------------------------------------------------------
    // Detect and prevent multiple tabs running ezEML simultaneously
    // --------------------------------------------------------------------------------------------------------------------

    // We use a custom modal dialog rather than the built-in alert() function because the latter causes execution to halt.
    // We want the claim_main messages to continue to be sent while the dialog is displayed so that the other tab is
    // notified that another tab is open.
    </script>

    <style>
        .modal {
            display: none;
            position: fixed;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: white;
            padding: 20px;
            border-radius: 5px;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.25);
        }
        .modal button {
            margin-top: 10px;
        }
    </style>

    <div id="myModal" class="modal">
        <div class="modal-content">
            <p>ezEML is open in another tab or browser window. ezEML does not support being open in more than one tab at a time.</p>
            <p>Please close one of the tabs before continuing.</p>
            <button onclick="closeModal()">Close</button>
        </div>
    </div>

    <script>
        function showModal() {
            document.getElementById('myModal').style.display = 'flex';
        }

        function closeModal() {
            document.getElementById('myModal').style.display = 'none';
        }
    </script>

    <script>
    // This function gets or creates a session-wide instanceId. This identifies a tab's session uniquely so we can
    // determine if a claim_main message is coming from the same session (i.e., tab) or a different one.
    function getSessionInstanceId() {
        let instanceId = sessionStorage.getItem('sessionInstanceId');
        if (!instanceId) {
            instanceId = Math.random().toString(36).substr(2, 9);
            sessionStorage.setItem('sessionInstanceId', instanceId);
        }
        return instanceId;
    }

    // Get the instanceId for this session
    const instanceId = getSessionInstanceId();

    // The BroadcastChannel API allows us to send messages between tabs. We use it to send a message to all other tabs.
    const channelName = 'ezEML_instance_channel';
    const channel = new BroadcastChannel(channelName);

    // When a message is received, check if it's from the same session. If not, show the alert.
    let alertTime = new Date();
    let isAlertOpen = false;
    function showAlert() {
        let currentDateTime = new Date();
        // If the last alert was less than half a second ago (i.e., we just closed the alert),
        //  don't show it again.
        if (currentDateTime - alertTime > 500) {
            console.log('Alerting user', currentDateTime);
            showModal();
        } else {
            console.log('Alert suppressed', currentDateTime);
        }
        alertTime = new Date();
    }

    channel.onmessage = (event) => {
        console.log('Received message:', event.data);
        if (event.data.type === 'claim_main') {
            if (event.data.id !== instanceId) {
                console.log('App is already open in another tab ' + event.data.id);
                showAlert();
            }
        }
        if (event.data.type === 'main_closed') {
            handleMainClosed();
        }
    };

    function claimMainInstance() {
        console.log('Claiming main instance status, id:', instanceId, ' at ', new Date());
        channel.postMessage({ type: 'claim_main', id: instanceId });
    }

    function handleMainClosed() {
        console.log('handleMainClosed');
        // We are being informed that the other tab closed. We are probably sitting with an open modal dialog. Close it.
        closeModal();
        // Main instance closed, try to claim main status
        claimMainInstance();
    }

    // Try to claim main instance status when the page loads
    claimMainInstance();

    // Periodically try to claim main instance status
    setInterval(claimMainInstance, 2000);

    // When the tab is closing or refreshing
    window.addEventListener('beforeunload', (event) => {
        console.log('beforeunload');
        channel.postMessage({ type: 'main_closed' });
    });
    </script>
    {% endblock %}
{% endblock %}