<!DOCTYPE html>
<html>
<head>
    <title>Preview Geographic Coverage</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap&libraries=&v=weekly" async></script>
    <script>

        function allCoordsSame(coords) {
            if (coords.length > 0) {
                const first = coords[0];
                return coords.every(coord => coord.lat() === first.lat() && coord.lng() === first.lng());
            }
            return true;
        }

    function initMap() {

      // Create the map
      const map = new google.maps.Map(document.getElementById('map'), { zoom: 8});

      let bounds = new google.maps.LatLngBounds();

      // Process locations
      const locations = {{ locations | safe }};
      locations.forEach(location => {
        if (location.north === location.south && location.east === location.west) {
          // It's a point
          const point = { lat: location.north, lng: location.east };
          new google.maps.Marker({
            position: point,
            map: map,
            title: 'Point'
          });
          bounds.extend(point);
        } else {
          // It's a bounding box
        const rectangleBounds = {
            north: location.north,
            south: location.south,
            east: location.east,
            west: location.west
          };
          new google.maps.Rectangle({
            bounds: rectangleBounds,
            map: map,
            fillColor: "#5990bd",
            fillOpacity: 0.35,
            strokeColor: "#5990bd",
            strokeOpacity: 0.8,
            strokeWeight: 2
          });
          bounds.extend({ lat: location.north, lng: location.east });
          bounds.extend({ lat: location.south, lng: location.west });
        }
      });

      // Check if only one point is present
      if (locations.length === 1 && locations[0].north === locations[0].south && locations[0].east === locations[0].west) {
        // Set map center and a reasonable zoom level for a single point
        const singlePoint = { lat: locations[0].north, lng: locations[0].east };
        map.setCenter(singlePoint);
        map.setZoom(14); // Adjust zoom level as needed
      } else {
        // Set the calculated bounds to the map, which will adjust the center and zoom
        map.fitBounds(bounds);
      }
    };

    window.onload = initMap;



        {##}
        {##}
        {#function initMap() {#}
        {#    alert("{{ bounding_boxes }}");#}
        {#    setTimeout(function() {#}
        {##}
        {#    {% for coordinates in bounding_boxes %}#}
        {#        alert("{{ coordinates }}");#}
        {##}
        {#    const mapCenter = { lat: {{ coordinates[0][0] }}, lng: {{ coordinates[0][1] }} };#}
        {#    const map = new google.maps.Map(document.getElementById("map"), {#}
        {#        zoom: 10,#}
        {#        center: mapCenter,#}
        {#    });#}
        {##}
        {#    const polygonCoords = [#}
        {#        {% for lat, lng in coordinates %}#}
        {#            new google.maps.LatLng({{ lat }}, {{ lng }}),#}
        {#        {% endfor %}#}
        {#    ];#}
        {##}
        {#    if (polygonCoords.length == 1 || allCoordsSame(polygonCoords)) {#}
        {#        map.setCenter(polygonCoords[0]);#}
        {#        new google.maps.Marker({#}
        {#            position: polygonCoords[0],#}
        {#            map: map,#}
        {#        });#}
        {#        map.setZoom(15);#}
        {##}
        {#    } else {#}
        {#        const polygon = new google.maps.Polygon({#}
        {#            paths: polygonCoords,#}
        {#            strokeColor: "#5990bd",#}
        {#            strokeOpacity: 0.8,#}
        {#            strokeWeight: 2,#}
        {#            fillColor: "#5990bd",#}
        {#            fillOpacity: 0.35,#}
        {#        });#}
        {##}
        {#        polygon.setMap(map);#}
        {##}
        {#        // Create a new bounds object#}
        {#        const bounds = new google.maps.LatLngBounds();#}
        {##}
        {#        // Extend the bounds to include each point of the polygon#}
        {#        polygonCoords.forEach(function(coord) {#}
        {#            bounds.extend(coord);#}
        {#        });#}
        {##}
        {#        // Fit the map to the new bounds#}
        {#        map.fitBounds(bounds);#}
        {#        {% endfor %}#}
        {##}
        {#        // Listen for the 'idle' event on the map and then adjust the zoom#}
                {#google.maps.event.addListenerOnce(map, 'idle', function() {#}
                {#    map.setZoom(map.getZoom() - 1); // Zoom out by one level after the map has fit the bounds#}
                {#});#}
        {#    }#}

    </script>
</head>
<body>
    <div id="map"></div>
</body>
</html>
