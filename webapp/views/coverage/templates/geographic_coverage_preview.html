<!DOCTYPE html>
<html>
<head>
    <title>Preview Geographic Coverage</title>
    <style>
        #map {
            height: 600px;
            width: 100%;
        }
    </style>
    <script src="https://maps.googleapis.com/maps/api/js?key={{ api_key }}&callback=initMap&libraries=&v=weekly" async></script>
    <script>

        function allCoordsSame(coords) {
            if (coords.length > 0) {
                const first = coords[0];
                return coords.every(coord => coord.lat() === first.lat() && coord.lng() === first.lng());
            }
            return true;
        }

        window.onload=function() {
        function initMap() {
            const mapCenter = { lat: {{ coordinates[0][0] }}, lng: {{ coordinates[0][1] }} };
            const map = new google.maps.Map(document.getElementById("map"), {
                zoom: 10,
                center: mapCenter,
            });

            const polygonCoords = [
                {% for lat, lng in coordinates %}
                    new google.maps.LatLng({{ lat }}, {{ lng }}),
                {#{ lat: {{ lat }}, lng: {{ lng }} },#}
                {% endfor %}
            ];

            if (polygonCoords.length == 1 || allCoordsSame(polygonCoords)) {
                map.setCenter(polygonCoords[0]);
                new google.maps.Marker({
                    position: polygonCoords[0],
                    map: map,
                    fillColor: "#FF0000"
                });

            } else {
                const polygon = new google.maps.Polygon({
                    paths: polygonCoords,
                    strokeColor: "#5990bd",
                    strokeOpacity: 0.8,
                    strokeWeight: 2,
                    fillColor: "#5990bd",
                    fillOpacity: 0.35,
                });

                polygon.setMap(map);

                // Create a new bounds object
                const bounds = new google.maps.LatLngBounds();

                // Extend the bounds to include each point of the polygon
                polygonCoords.forEach(function(coord) {
                    bounds.extend(coord);
                });

                // Fit the map to the new bounds
                map.fitBounds(bounds);
            }

            // Listen for the 'idle' event on the map and then adjust the zoom
            {#google.maps.event.addListenerOnce(map, 'idle', function() {#}
            {#    map.setZoom(map.getZoom() - 1); // Zoom out by one level after the map has fit the bounds#}
            {#});#}
        }
        };
    </script>
</head>
<body>
    <div id="map"></div>
</body>
</html>
